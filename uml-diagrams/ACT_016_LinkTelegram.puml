@startuml ACT_016_LinkTelegram
start
:User truy cập Settings > Telegram Integration;
:User nhấn "Liên kết Telegram";
:Tạo link code (16 ký tự, unique);
:Lưu vào telegram_link_codes
với expires_at = now() + 10 phút;
:Hiển thị link code cho user;
:User mở Telegram Bot;
:User gửi lệnh /link;
:Bot yêu cầu user nhập link code;
:User nhập link code;
:Bot validate code:
kiểm tra tồn tại, chưa hết hạn, chưa được dùng;
if (Code hết hạn?) then (có)
  :Bot thông báo "Code đã hết hạn";
  :Yêu cầu tạo code mới;
  stop
endif
if (Code đã được dùng?) then (có)
  :Bot thông báo "Code đã được sử dụng";
  stop
endif
if (Telegram account đã liên kết?) then (có)
  :Bot thông báo "Tài khoản đã được liên kết";
  stop
endif
:Lưu telegram_user_id và web_user_id
vào telegram_accounts;
:Đánh dấu code đã dùng (used_at = now());
:Bot thông báo "Liên kết thành công";
:Web app cập nhật trạng thái "Đã liên kết";
stop
@enduml

