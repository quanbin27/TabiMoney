@startuml Sequence_Authentication
actor User
participant "Frontend" as Frontend
participant "Backend API" as Backend
participant "Auth Service" as Auth
participant "Database" as DB
participant "JWT Service" as JWT

== Đăng ký ==
User -> Frontend: Điền form đăng ký
Frontend -> Backend: POST /api/v1/auth/register
Backend -> Auth: Register(request)
Auth -> DB: Kiểm tra email/username tồn tại
alt Email/Username đã tồn tại
    DB --> Auth: Conflict
    Auth --> Backend: Error
    Backend --> Frontend: 409 Conflict
    Frontend --> User: Hiển thị lỗi
else Email/Username hợp lệ
    Auth -> Auth: Hash password
    Auth -> DB: INSERT INTO users
    DB --> Auth: User created
    Auth -> DB: INSERT INTO user_profiles
    DB --> Auth: Profile created
    Auth -> JWT: Generate tokens
    JWT --> Auth: AccessToken + RefreshToken
    Auth --> Backend: AuthResponse
    Backend --> Frontend: 201 Created
    Frontend --> User: Đăng ký thành công
end

== Đăng nhập ==
User -> Frontend: Nhập email/password
Frontend -> Backend: POST /api/v1/auth/login
Backend -> Auth: Login(request)
Auth -> DB: SELECT user WHERE email
DB --> Auth: User data
Auth -> Auth: Verify password
alt Mật khẩu sai
    Auth --> Backend: Error
    Backend --> Frontend: 401 Unauthorized
    Frontend --> User: Sai mật khẩu
else Mật khẩu đúng
    Auth -> DB: UPDATE last_login_at
    Auth -> JWT: Generate tokens
    JWT --> Auth: Tokens
    Auth -> DB: INSERT INTO user_sessions
    Auth --> Backend: AuthResponse
    Backend --> Frontend: 200 OK
    Frontend --> User: Đăng nhập thành công
end

@enduml

