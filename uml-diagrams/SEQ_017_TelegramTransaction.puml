@startuml SEQ_017_TelegramTransaction
actor User
actor "Telegram Bot" as Telegram
participant "AI Service" as AIService
participant "Transaction Service" as TxService
participant "Database" as DB

User -> Telegram: Gửi tin nhắn: "ăn bún bò 50k"
Telegram -> Telegram: Lấy telegram_user_id
Telegram -> DB: SELECT web_user_id FROM telegram_accounts
DB --> Telegram: web_user_id

alt Chưa liên kết
    DB --> Telegram: NULL
    Telegram --> User: "Bạn chưa liên kết tài khoản. Dùng /link để liên kết."
else Đã liên kết
    Telegram -> AIService: POST {AI_SERVICE_URL}/api/v1/chat/process\n(Authorization: Telegram JWT,\n user_id, message)
    AIService -> TxService: Xử lý intent + truy vấn dữ liệu user
    TxService -> DB: Query transactions/categories/budgets
    DB --> TxService: Context data
    TxService --> AIService: Context

    alt Intent = add_transaction
        AIService -> DB: INSERT INTO transactions\n(through TxService)
        DB --> AIService: Transaction created
    end

    AIService --> Telegram: ChatResponse (response, suggestions)
    Telegram -> Telegram: Format message
    Telegram --> User: "✅ Đã thêm: Ăn uống - 50,000 VND"
end

@enduml

